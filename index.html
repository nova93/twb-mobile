<!DOCTYPE html>
<html>
<head>
	<title>The Whiteboard Mobile</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>body{margin:0;font-family:sans-serif}nav{width:calc(100% - 20px);position:fixed;bottom:0;padding:0 10px;display:flex;text-align:center;background-color:#eee}nav a{flex:auto;text-decoration:none;padding:20px}#comic{width:calc(100% - 16px);overflow-x:scroll;margin:8px;height:calc(100vh - 130px);text-align:center}
	</style>
</head>
<body>
	<div id="comic"></div>
	<nav></nav>
	
	<script type="text/javascript">
		getUrlVars = () => {
		    const vars = {};
		    const parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m,key,value) => {
		        vars[key] = value;
		    });
		    return vars;
		}
		const proxyUrl = 'https://yacdn.org/serve/';
		let twbUrl = 'http://the-whiteboard.com';
		if (getUrlVars()['page']) {
			twbUrl = 'http://the-whiteboard.com/' + getUrlVars()['page'];
		}
		const url = proxyUrl + twbUrl;

		// image
		const regex = /<br><img SRC=".*"><br>/gmi;
		const regex2 = /".*"/gmi;

		// buttons
		const regex3 = /<a href=".{4,15}\.html"><img src="previous\.png"><\/a>/gmi; // previous
		const regex4 = /<a href=".{4,15}\.html"><img src="next\.png"><\/a>/gmi; // next

		fetch(url).then( response => {
			if(response.ok) {
				return response.text();
			}
			throw new Error('Network response was not ok.');
		}).then( rawResponse => {
			let imgName = rawResponse.match(regex)[0].match(regex2)[0]; //there is probably a better way to do that EDIT: there is, use what i've done to prevBtn...
			imgName = imgName.substring(1, imgName.length - 1);
			showImage(imgName);

			const nav = document.getElementsByTagName('NAV')[0];
			let prevBtn = null;
			let nextBtn = null;
			
			if (rawResponse.match(regex3)) {
				prevBtn = rawResponse.match(regex3)[0];
			}
			if (prevBtn) {
				prevBtn = prevBtn.substring(9, prevBtn.length - 30);
				const prev = document.createElement('a');
				const prevText = document.createTextNode('Prev');
				prev.appendChild(prevText);
				prev.setAttribute('href', '?page=' + prevBtn);
				nav.appendChild(prev);
			}

			const first = document.createElement('a');
			const firstText = document.createTextNode('First');
			first.appendChild(firstText);
			first.setAttribute('href', '?page=autowb001.html');
			nav.appendChild(first);

			const todays = document.createElement('a');
			const todaysText = document.createTextNode('Todays');
			todays.appendChild(todaysText);
			todays.setAttribute('href', 'index.html');
			nav.appendChild(todays);

			if (rawResponse.match(regex4)) {
				nextBtn = rawResponse.match(regex4)[0]
			}
			if (nextBtn) {
				nextBtn = nextBtn.substring(9, nextBtn.length - 26);
				const next = document.createElement('a');
				const nextText = document.createTextNode('Next');
				next.appendChild(nextText);
				next.setAttribute('href', '?page=' + nextBtn);
				nav.appendChild(next);
			}
		

		}).catch( error => {
		  console.log(error);
		});

		const loadImage = url => {
		  	return new Promise( (resolve, reject) => {
			    const image = new Image();
			    image.src = url;
			    image.onload = () => {
		    		resolve(image.src);
		    	};
		    	image.onerror = () => {
		    		reject(new Error('Could not load image at ' + url));
		    	};
			});
		}
		const handleSuccess = resolvedValue => {
			const comic = new Image();
			comic.src = resolvedValue;
			document.getElementById('comic').appendChild(comic);
		}
		const handleFailure = rejectionReason => {
			console.log(rejectionReason);
		}
		const showImage = (url) => {
			const path = 'http://the-whiteboard.com/' + url;
			loadImage(path).then(handleSuccess, handleFailure);
		}
	</script>
</body>
</html>
